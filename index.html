<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quest</title>
    <meta name="theme-color" content="#5a3d7a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Daily Quest">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #00b894; --primary-dark: #00a381; --primary-light: #55efc4; --purple: #5a3d7a; --purple-light: #8e6aae; --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 50%, #f1f8f4 100%); --bg-card: #ffffff; --text-dark: #2d3436; --text-muted: #636e72; --success: #00b894; --danger: #e74c3c; --warning: #f39c12; --persistent: #9b59b6; --persistent-light: #f5eef8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg-gradient); color: var(--text-dark); min-height: 100vh; }
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; }
        .login-logo { width: 100px; height: 100px; border-radius: 24px; margin-bottom: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .login-title { font-family: 'Cinzel', serif; font-size: 28px; color: var(--purple); margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; font-size: 14px; }
        .login-box { width: 100%; max-width: 320px; }
        .login-section { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .login-section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; font-weight: 600; }
        .google-btn { display: flex; align-items: center; justify-content: center; gap: 12px; background: white; color: #333; border: 2px solid #eee; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .google-btn svg { width: 20px; height: 20px; }
        .login-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; font-family: inherit; margin-bottom: 10px; text-align: center; }
        .login-input:focus { outline: none; border-color: var(--primary); }
        .login-input.id-code { text-transform: uppercase; font-family: 'Courier New', monospace; font-size: 18px; letter-spacing: 4px; }
        .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .login-divider { display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 13px; margin: 20px 0; }
        .login-divider::before, .login-divider::after { content: ''; flex: 1; height: 1px; background: #ddd; }
        .login-error { color: var(--danger); font-size: 13px; text-align: center; margin-top: 10px; }
        .app-container { max-width: 480px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-card); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-left h1 { font-family: 'Cinzel', serif; font-size: 20px; color: var(--purple); margin-bottom: 4px; }
        .header-date { font-size: 13px; color: var(--text-muted); }
        .level-display { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 14px; border-radius: 16px; color: white; }
        .level-badge { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .level-info { display: flex; flex-direction: column; }
        .level-text { font-size: 11px; opacity: 0.9; }
        .exp-bar { width: 60px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .exp-fill { height: 100%; background: #ffd700; border-radius: 3px; transition: width 0.5s ease; }
        .streak-banner { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); border-radius: 16px; padding: 16px; margin-bottom: 16px; color: white; display: flex; align-items: center; gap: 12px; }
        .streak-icon { font-size: 32px; animation: flame 0.5s ease-in-out infinite alternate; }
        @keyframes flame { from { transform: scale(1); } to { transform: scale(1.1); } }
        .streak-info { flex: 1; }
        .streak-count { font-size: 24px; font-weight: 700; }
        .streak-label { font-size: 12px; opacity: 0.9; }
        .mode-toggle { display: flex; background: #f0f0f0; border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .mode-btn .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
        .progress-section { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .progress-title { font-weight: 600; font-size: 14px; color: #555; }
        .progress-count { color: var(--primary); font-weight: 700; }
        .progress-bar { height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 6px; transition: width 0.5s ease; }
        .week-summary { display: flex; justify-content: space-between; gap: 4px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0; }
        .week-day { flex: 1; text-align: center; padding: 6px 2px; border-radius: 8px; font-size: 10px; font-weight: 600; }
        .week-day.completed { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); color: #2d7a3a; }
        .week-day.today { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .week-day.future { background: #f5f5f5; color: #aaa; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { font-family: 'Cinzel', serif; font-size: 16px; color: var(--primary); }
        .quest-list { display: flex; flex-direction: column; gap: 10px; }
        .quest-item { background: var(--bg-card); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); cursor: pointer; }
        .quest-item.completed { opacity: 0.7; background: #f8fff8; }
        .quest-item.completed .quest-title { text-decoration: line-through; color: #888; }
        .quest-item.persistent { background: linear-gradient(135deg, var(--persistent-light) 0%, #f5eef8 100%); border-left: 4px solid var(--persistent); }
        .quest-checkbox { width: 28px; height: 28px; border: 2px solid #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .quest-item.completed .quest-checkbox { background: var(--success); border-color: var(--success); }
        .quest-checkbox::after { content: '‚úì'; color: white; font-weight: bold; opacity: 0; }
        .quest-item.completed .quest-checkbox::after { opacity: 1; }
        .quest-content { flex: 1; }
        .quest-title { font-weight: 600; margin-bottom: 4px; font-size: 15px; color: #444; }
        .quest-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .quest-category { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .category-home { background: #ffebee; color: #c62828; }
        .category-work { background: #e3f2fd; color: #1565c0; }
        .category-health { background: #e8f5e9; color: #2e7d32; }
        .category-finance { background: #fff8e1; color: #f57f17; }
        .category-learning { background: #f3e5f5; color: #7b1fa2; }
        .category-personal { background: #fce4ec; color: #c2185b; }
        .exp-reward { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-title { font-size: 18px; color: #666; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; background: none; border: none; color: #aaa; font-size: 10px; cursor: pointer; padding: 6px 12px; border-radius: 12px; }
        .nav-item.active { color: var(--primary); background: rgba(0,184,148,0.1); }
        .nav-icon { font-size: 18px; }
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border: none; border-radius: 50%; color: white; font-size: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,184,148,0.4); z-index: 100; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border-radius: 16px; padding: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card.streak { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: white; }
        .stat-card.exp { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-card.rate { background: linear-gradient(135deg, #00b894 0%, #55efc4 100%); color: white; }
        .stat-card.quests { background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%); color: white; }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-label { font-size: 11px; opacity: 0.9; margin-top: 4px; }
        .chart-section { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .chart-title { font-weight: 700; margin-bottom: 16px; font-size: 14px; }
        .chart-bars { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 8px; }
        .chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .chart-bar { width: 100%; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 6px 6px 0 0; }
        .chart-bar-label { font-size: 10px; color: var(--text-muted); }
        .chart-bar-value { font-size: 10px; font-weight: 600; color: var(--primary); }
        .category-stats { display: flex; flex-direction: column; gap: 10px; }
        .category-stat { display: flex; align-items: center; gap: 12px; }
        .category-stat-bar { flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .category-stat-fill { height: 100%; border-radius: 4px; }
        .category-stat-count { font-size: 12px; font-weight: 600; min-width: 30px; text-align: right; }
        .rewards-balance { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 24px; margin-bottom: 20px; color: white; text-align: center; }
        .balance-label { font-size: 12px; opacity: 0.9; }
        .balance-value { font-size: 36px; font-weight: 700; }
        .balance-sub { font-size: 12px; opacity: 0.8; margin-top: 4px; }
        .reward-item { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .reward-icon { font-size: 32px; }
        .reward-content { flex: 1; }
        .reward-title { font-weight: 700; margin-bottom: 4px; }
        .reward-cost { font-size: 13px; color: var(--purple); font-weight: 600; }
        .reward-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 13px; }
        .reward-btn.can-afford { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .reward-btn.cannot-afford { background: #f0f0f0; color: #aaa; cursor: not-allowed; }
        .pending-rewards { margin-top: 20px; }
        .pending-title { font-weight: 700; margin-bottom: 12px; font-size: 14px; color: var(--warning); }
        .pending-item { background: #fffbf0; border: 2px solid var(--warning); border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .achievement-item { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .achievement-item.locked { opacity: 0.5; }
        .achievement-icon { font-size: 36px; }
        .achievement-content { flex: 1; }
        .achievement-title { font-weight: 700; }
        .achievement-desc { font-size: 12px; color: var(--text-muted); }
        .achievement-progress { font-size: 11px; color: var(--primary); font-weight: 600; margin-top: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; width: 100%; max-width: 480px; max-height: 90vh; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s; overflow-y: auto; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-family: 'Cinzel', serif; font-size: 20px; color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 24px; color: #aaa; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #555; }
        .form-input, .form-select { width: 100%; padding: 14px; background: #f9f9f9; border: 2px solid #eee; border-radius: 12px; font-size: 16px; font-family: inherit; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }
        .quest-type-toggle { display: flex; gap: 10px; margin-bottom: 16px; }
        .quest-type-btn { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; text-align: center; }
        .quest-type-btn.active { border-color: var(--primary); background: rgba(0,184,148,0.1); }
        .quest-type-btn.persistent.active { border-color: var(--persistent); background: var(--persistent-light); }
        .quest-type-btn span { display: block; font-size: 20px; }
        .quest-type-btn small { font-size: 12px; color: var(--text-muted); }
        .days-selector { display: flex; flex-wrap: wrap; gap: 8px; }
        .day-checkbox { display: none; }
        .day-label { padding: 10px 14px; background: #f5f5f5; border: 2px solid #eee; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .day-checkbox:checked + .day-label { background: var(--primary); border-color: var(--primary); color: white; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .btn-danger { background: #fff0f0; color: var(--danger); }
        .btn-secondary { background: #f5f5f5; color: #666; }
        .btn-sm { padding: 10px 16px; font-size: 14px; width: auto; }
        .btn-group { display: flex; gap: 12px; margin-top: 16px; }
        .btn-group .btn { flex: 1; }
        .settings-section { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .settings-title { font-weight: 700; margin-bottom: 12px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { font-weight: 600; }
        .settings-value { color: var(--text-muted); font-size: 14px; }
        .id-code-box { background: #f5f5f5; border-radius: 12px; padding: 16px; text-align: center; margin-top: 12px; }
        .id-code-value { font-family: 'Courier New', monospace; font-size: 28px; font-weight: 700; color: var(--purple); letter-spacing: 4px; }
        .id-code-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .verify-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .verify-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
        .verify-user { display: flex; align-items: center; gap: 10px; }
        .verify-name { font-weight: 700; }
        .verify-count { font-size: 12px; color: var(--text-muted); }
        .verify-quest { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
        .verify-quest:last-child { border-bottom: none; }
        .verify-quest-info { display: flex; align-items: center; gap: 10px; }
        .verify-actions { display: flex; gap: 8px; }
        .btn-icon { width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn-verify { background: rgba(0,184,148,0.2); color: var(--success); }
        .btn-reject { background: rgba(231,76,60,0.2); color: var(--danger); }
        .history-item { background: var(--bg-card); border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .history-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; cursor: pointer; }
        .history-left { display: flex; align-items: center; gap: 12px; }
        .history-date { font-weight: 700; font-size: 14px; }
        .history-summary { font-size: 12px; font-weight: 600; }
        .history-summary.success { color: var(--success); }
        .history-summary.pending { color: var(--warning); }
        .history-details { padding: 12px 16px; background: #fafafa; border-top: 1px solid #f0f0f0; }
        .history-quest { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 14px; }
        .history-check { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .history-check.done { background: var(--success); color: white; }
        .history-check.undone { background: #e0e0e0; color: #999; }
        .hidden { display: none !important; }
        .celebration { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; animation: fall 3s forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .reward-icon-btn { padding: 10px 14px; font-size: 20px; border: 2px solid #eee; border-radius: 10px; background: white; cursor: pointer; }
        .reward-icon-btn.selected { border-color: var(--primary); background: rgba(0,184,148,0.1); }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <img src="icon-512.png" class="login-logo" alt="Daily Quest">
        <h1 class="login-title">Daily Quest</h1>
        <p class="login-subtitle">Gamify tugasan harian anda</p>
        <div class="login-box">
            <div class="login-section">
                <div class="login-section-title">Pengguna Baru</div>
                <button class="google-btn" onclick="signInWithGoogle()">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Daftar dengan Google
                </button>
            </div>
            <div class="login-divider">atau</div>
            <div class="login-section">
                <div class="login-section-title">Sudah Ada Akaun</div>
                <input type="text" class="login-input id-code" id="loginIdCode" placeholder="ID CODE" maxlength="6">
                <input type="password" class="login-input" id="loginPin" placeholder="PIN (4 digit)" maxlength="4" inputmode="numeric">
                <button class="login-btn" onclick="loginWithIdCode()">Masuk</button>
                <div class="login-error hidden" id="loginError"></div>
            </div>
        </div>
    </div>
    <div id="setupPinScreen" class="login-screen hidden">
        <img src="icon-512.png" class="login-logo" alt="Daily Quest">
        <h1 class="login-title">Setup PIN</h1>
        <p class="login-subtitle">Cipta PIN 4 digit untuk login seterusnya</p>
        <div class="login-box">
            <div class="login-section">
                <input type="password" class="login-input" id="newPin" placeholder="PIN Baru (4 digit)" maxlength="4" inputmode="numeric">
                <input type="password" class="login-input" id="confirmPin" placeholder="Sahkan PIN" maxlength="4" inputmode="numeric">
                <button class="login-btn" onclick="setupPin()">Simpan PIN</button>
                <div class="login-error hidden" id="pinError"></div>
            </div>
        </div>
    </div>
    <div id="mainApp" class="hidden">
        <div class="app-container">
            <header class="header">
                <div class="header-left"><h1>Daily Quest</h1><div class="header-date" id="headerDate"></div></div>
                <div class="level-display">
                    <div class="level-badge" id="levelBadge">1</div>
                    <div class="level-info"><span class="level-text">Level <span id="levelNum">1</span></span><div class="exp-bar"><div class="exp-fill" id="expFill"></div></div></div>
                </div>
            </header>
            <main id="mainContent"></main>
        </div>
        <button class="fab" id="fabBtn" onclick="openAddModal()">+</button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="today" onclick="switchScreen('today')"><span class="nav-icon">‚öîÔ∏è</span><span>Hari Ini</span></button>
            <button class="nav-item" data-screen="stats" onclick="switchScreen('stats')"><span class="nav-icon">üìä</span><span>Statistik</span></button>
            <button class="nav-item" data-screen="rewards" onclick="switchScreen('rewards')"><span class="nav-icon">üéÅ</span><span>Rewards</span></button>
            <button class="nav-item" data-screen="history" onclick="switchScreen('history')"><span class="nav-icon">üìú</span><span>Sejarah</span></button>
            <button class="nav-item" data-screen="settings" onclick="switchScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span><span>Lagi</span></button>
        </nav>
    </div>
    <div class="modal-overlay" id="questModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title" id="modalTitle">Tambah Quest</h2><button class="modal-close" onclick="closeModal('questModal')">√ó</button></div>
        <div class="quest-type-toggle">
            <button class="quest-type-btn active" id="typeDaily" onclick="setQuestType('daily')"><span>üìÖ</span><small>Harian</small></button>
            <button class="quest-type-btn persistent" id="typePersistent" onclick="setQuestType('persistent')"><span>üìå</span><small>Berterusan</small></button>
        </div>
        <div class="form-group"><label class="form-label">Tajuk Quest</label><input type="text" class="form-input" id="questTitle"></div>
        <div class="form-group"><label class="form-label">Kategori</label><select class="form-select" id="questCategory"><option value="home">üè† Rumah</option><option value="work">üíº Kerja</option><option value="health">üí™ Kesihatan</option><option value="finance">üí∞ Kewangan</option><option value="learning">üìö Pembelajaran</option><option value="personal">üéØ Peribadi</option></select></div>
        <div class="form-group" id="daysGroup"><label class="form-label">Ulang pada</label><div class="days-selector" id="daysSelector"></div></div>
        <button class="btn btn-primary" onclick="saveQuest()">Simpan</button>
    </div></div>
    <div class="modal-overlay" id="deleteModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title">Padam?</h2><button class="modal-close" onclick="closeModal('deleteModal')">√ó</button></div>
        <p style="margin-bottom:20px">Adakah anda pasti?</p>
        <div class="btn-group"><button class="btn btn-secondary" onclick="closeModal('deleteModal')">Batal</button><button class="btn btn-danger" onclick="confirmDelete()">Padam</button></div>
    </div></div>
    <div class="modal-overlay" id="rewardModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title" id="rewardModalTitle">Tambah Reward</h2><button class="modal-close" onclick="closeModal('rewardModal')">√ó</button></div>
        <div class="form-group"><label class="form-label">Nama Reward</label><input type="text" class="form-input" id="rewardTitle" placeholder="cth: Ice cream"></div>
        <div class="form-group"><label class="form-label">Kos (EXP)</label><input type="number" class="form-input" id="rewardCost" placeholder="100" min="10" step="10"></div>
        <div class="form-group"><label class="form-label">Icon</label><div style="display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üç¶')">üç¶</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üéÆ')">üéÆ</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üé¨')">üé¨</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üõí')">üõí</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('‚òï')">‚òï</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üçï')">üçï</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üéµ')">üéµ</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üì±')">üì±</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üíÜ')">üíÜ</button>
            <button type="button" class="reward-icon-btn" onclick="selectRewardIcon('üéÅ')">üéÅ</button>
        </div></div>
        <button class="btn btn-primary" onclick="saveReward()">Simpan Reward</button>
    </div></div>
    <div class="modal-overlay" id="assignModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title">Assign Quest</h2><button class="modal-close" onclick="closeModal('assignModal')">√ó</button></div>
        <p style="margin-bottom:16px">Assign kepada: <strong id="assignToName"></strong></p>
        <div class="quest-type-toggle">
            <button class="quest-type-btn active" id="assignTypeDaily" onclick="setAssignType('daily')"><span>üìÖ</span><small>Harian</small></button>
            <button class="quest-type-btn persistent" id="assignTypePersistent" onclick="setAssignType('persistent')"><span>üìå</span><small>Berterusan</small></button>
        </div>
        <div class="form-group"><label class="form-label">Tajuk Quest</label><input type="text" class="form-input" id="assignTitle"></div>
        <div class="form-group"><label class="form-label">Kategori</label><select class="form-select" id="assignCategory"><option value="home">üè† Rumah</option><option value="work">üíº Kerja</option><option value="health">üí™ Kesihatan</option><option value="finance">üí∞ Kewangan</option><option value="learning">üìö Pembelajaran</option><option value="personal">üéØ Peribadi</option></select></div>
        <button class="btn btn-primary" onclick="submitAssign()">Assign</button>
    </div></div>
    <div class="modal-overlay" id="verifierModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title">Tambah Pengesah</h2><button class="modal-close" onclick="closeModal('verifierModal')">√ó</button></div>
        <div class="form-group"><label class="form-label">ID Code Pengesah</label><input type="text" class="form-input id-code" id="verifierIdCode" placeholder="XXXXXX" maxlength="6" style="text-transform:uppercase"></div>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Minta ID Code dari pengesah anda</p>
        <button class="btn btn-primary" onclick="addVerifier()">Tambah</button>
    </div></div>
    <div class="modal-overlay" id="changePinModal"><div class="modal">
        <div class="modal-header"><h2 class="modal-title">Tukar PIN</h2><button class="modal-close" onclick="closeModal('changePinModal')">√ó</button></div>
        <div class="form-group"><label class="form-label">PIN Semasa</label><input type="password" class="form-input" id="currentPinInput" maxlength="4" inputmode="numeric"></div>
        <div class="form-group"><label class="form-label">PIN Baru</label><input type="password" class="form-input" id="newPinInput" maxlength="4" inputmode="numeric"></div>
        <button class="btn btn-primary" onclick="changePin()">Tukar PIN</button>
    </div></div>
    <div class="celebration" id="celebration"></div>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCzjLQqOFHFKLescOm3XeNtP5vceNInW6s", authDomain: "dailyquest-e7d7b.firebaseapp.com", projectId: "dailyquest-e7d7b", storageBucket: "dailyquest-e7d7b.firebasestorage.app", messagingSenderId: "372073463598", appId: "1:372073463598:web:22aaa1c892a2256369c4bf", databaseURL: "https://dailyquest-e7d7b-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();
        
        let currentUser = null, currentScreen = 'today', questTemplates = [], todayQuests = [], persistentQuests = [];
        let userExp = 0, userLevel = 1, userStreak = 0, verifierUid = null, usersToVerify = [], pendingCount = 0;
        let isVerifierMode = false, questType = 'daily', assignType = 'daily', editingId = null, deleteTarget = null;
        let assignToUid = null, rewards = [], pendingRewards = [], selectedRewardIcon = 'üéÅ', editingRewardId = null, editingRewardUserUid = null;
        
        const days = ['Isn', 'Sel', 'Rab', 'Kha', 'Jum', 'Sab', 'Ahd'];
        const daysFull = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'];
        const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];
        
        function generateIdCode(uid) { const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let code = ''; for (let i = 0; i < 6; i++) code += chars.charAt((uid.charCodeAt(i % uid.length) * (i + 1) * 7) % chars.length); return code; }
        function getDateStr(d) { return d.toISOString().split('T')[0]; }
        function getCatIcon(cat) { return { home:'üè†', work:'üíº', health:'üí™', finance:'üí∞', learning:'üìö', personal:'üéØ' }[cat] || 'üìã'; }
        function getCatColor(cat) { return { home:'#c62828', work:'#1565c0', health:'#2e7d32', finance:'#f57f17', learning:'#7b1fa2', personal:'#c2185b' }[cat] || '#666'; }
        
        function checkSavedLogin() { const saved = localStorage.getItem('dq_credentials'); if (saved) { const { odUid, idCode } = JSON.parse(saved); currentUser = { odUid, idCode }; showMainApp(); } }
        
        function signInWithGoogle() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(async result => {
                const user = result.user, idCode = generateIdCode(user.uid);
                const snap = await db.ref(`users/${user.uid}`).once('value');
                if (!snap.exists()) await db.ref(`users/${user.uid}`).set({ email: user.email, displayName: user.displayName, idCode, totalExp: 0, streak: 0, createdAt: Date.now() });
                const userData = (await db.ref(`users/${user.uid}`).once('value')).val();
                if (userData.pin) { localStorage.setItem('dq_credentials', JSON.stringify({ odUid: user.uid, idCode: userData.idCode })); currentUser = { odUid: user.uid, idCode: userData.idCode }; showMainApp(); }
                else { currentUser = { odUid: user.uid, idCode: userData.idCode, needPin: true }; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('setupPinScreen').classList.remove('hidden'); }
            }).catch(err => alert('Login gagal: ' + err.message));
        }
        
        async function setupPin() {
            const pin = document.getElementById('newPin').value, confirm = document.getElementById('confirmPin').value, errorEl = document.getElementById('pinError');
            if (pin.length !== 4 || !/^\d+$/.test(pin)) { errorEl.textContent = 'PIN mesti 4 digit'; errorEl.classList.remove('hidden'); return; }
            if (pin !== confirm) { errorEl.textContent = 'PIN tidak sama'; errorEl.classList.remove('hidden'); return; }
            await db.ref(`users/${currentUser.odUid}/pin`).set(pin);
            localStorage.setItem('dq_credentials', JSON.stringify({ odUid: currentUser.odUid, idCode: currentUser.idCode }));
            document.getElementById('setupPinScreen').classList.add('hidden'); showMainApp();
        }
        
        async function loginWithIdCode() {
            const idCode = document.getElementById('loginIdCode').value.toUpperCase(), pin = document.getElementById('loginPin').value, errorEl = document.getElementById('loginError');
            if (!idCode || !pin) { errorEl.textContent = 'Sila masukkan ID Code dan PIN'; errorEl.classList.remove('hidden'); return; }
            const snap = await db.ref('users').orderByChild('idCode').equalTo(idCode).once('value');
            if (!snap.exists()) { errorEl.textContent = 'ID Code tidak dijumpai'; errorEl.classList.remove('hidden'); return; }
            let foundUid = null, userData = null; snap.forEach(c => { foundUid = c.key; userData = c.val(); });
            if (userData.pin !== pin) { errorEl.textContent = 'PIN salah'; errorEl.classList.remove('hidden'); return; }
            localStorage.setItem('dq_credentials', JSON.stringify({ odUid: foundUid, idCode })); currentUser = { odUid: foundUid, idCode }; showMainApp();
        }
        
        async function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('setupPinScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
            await loadUserData(); await loadTemplates(); await loadPersistent(); await generateToday(); await loadUsersToVerify(); await loadRewards(); await calculateStreak();
            updateHeader(); renderDays(); switchScreen('today');
        }
        
        async function loadUserData() {
            const snap = await db.ref(`users/${currentUser.odUid}`).once('value'); const data = snap.val() || {};
            userExp = data.totalExp || 0; userStreak = data.streak || 0; verifierUid = data.verifierUid || null;
            currentUser.displayName = data.displayName || 'User'; currentUser.email = data.email || ''; currentUser.idCode = data.idCode || generateIdCode(currentUser.odUid);
            updateLevel();
        }
        
        function calculateLevel(exp) { let lvl = 1, need = 100, rem = exp; while (rem >= need) { rem -= need; lvl++; need = lvl * 100; } return { level: lvl, current: rem, needed: need }; }
        function updateLevel() { const data = calculateLevel(userExp); userLevel = data.level; document.getElementById('levelBadge').textContent = userLevel; document.getElementById('levelNum').textContent = userLevel; document.getElementById('expFill').style.width = (data.current / data.needed * 100) + '%'; }
        async function addExp(amount) { const oldLvl = userLevel; userExp += amount; await db.ref(`users/${currentUser.odUid}/totalExp`).set(userExp); updateLevel(); if (userLevel > oldLvl) { playLevelUp(); celebrate(); } }
        async function deductExp(amount) { userExp = Math.max(0, userExp - amount); await db.ref(`users/${currentUser.odUid}/totalExp`).set(userExp); updateLevel(); }
        
        async function calculateStreak() {
            let streak = 0; const today = new Date();
            for (let i = 0; i < 365; i++) {
                const d = new Date(today); d.setDate(d.getDate() - i); const dateStr = getDateStr(d);
                const snap = await db.ref(`dailyQuests/${currentUser.odUid}/${dateStr}`).once('value');
                if (!snap.exists()) { if (i > 0) break; else continue; }
                const quests = []; snap.forEach(c => quests.push(c.val()));
                if (quests.length === 0) { if (i > 0) break; else continue; }
                const allDone = quests.every(q => ['completed','pending_verification','verified'].includes(q.status));
                if (allDone) streak++; else if (i > 0) break;
            }
            userStreak = streak; await db.ref(`users/${currentUser.odUid}/streak`).set(streak);
        }
        
        async function loadTemplates() { const snap = await db.ref(`questTemplates/${currentUser.odUid}`).once('value'); questTemplates = []; snap.forEach(c => questTemplates.push({ id: c.key, ...c.val() })); }
        async function loadPersistent() { const snap = await db.ref(`persistentQuests/${currentUser.odUid}`).once('value'); persistentQuests = []; snap.forEach(c => { const q = c.val(); if (q.status !== 'completed' && q.status !== 'verified') persistentQuests.push({ id: c.key, ...q }); }); }
        async function loadToday() { const snap = await db.ref(`dailyQuests/${currentUser.odUid}/${getDateStr(new Date())}`).once('value'); todayQuests = []; snap.forEach(c => todayQuests.push({ id: c.key, ...c.val() })); }
        
        async function generateToday() {
            const today = getDateStr(new Date()), dow = new Date().getDay(), adjDay = dow === 0 ? 7 : dow;
            const snap = await db.ref(`dailyQuests/${currentUser.odUid}/${today}`).once('value');
            const existing = snap.val() || {}, existIds = Object.values(existing).map(q => q.templateId);
            for (const t of questTemplates) { if (t.daysOfWeek && t.daysOfWeek.includes(adjDay) && !existIds.includes(t.id)) await db.ref(`dailyQuests/${currentUser.odUid}/${today}`).push({ templateId: t.id, title: t.title, category: t.category, status: 'pending', createdAt: Date.now() }); }
            await loadToday();
        }
        
        async function loadUsersToVerify() {
            usersToVerify = []; pendingCount = 0;
            const snap = await db.ref('users').orderByChild('verifierUid').equalTo(currentUser.odUid).once('value');
            snap.forEach(c => usersToVerify.push({ odUid: c.key, ...c.val() }));
            const today = getDateStr(new Date());
            for (const u of usersToVerify) {
                const qs = await db.ref(`dailyQuests/${u.odUid}/${today}`).once('value'); qs.forEach(c => { if (c.val().status === 'pending_verification') pendingCount++; });
                const ps = await db.ref(`persistentQuests/${u.odUid}`).once('value'); ps.forEach(c => { if (c.val().status === 'pending_verification') pendingCount++; });
                const rs = await db.ref(`pendingRewards/${u.odUid}`).once('value'); rs.forEach(() => pendingCount++);
            }
        }
        
        async function loadRewards() {
            const snap = await db.ref(`rewards/${currentUser.odUid}`).once('value'); rewards = []; snap.forEach(c => rewards.push({ id: c.key, ...c.val() }));
            const pSnap = await db.ref(`pendingRewards/${currentUser.odUid}`).once('value'); pendingRewards = []; pSnap.forEach(c => pendingRewards.push({ id: c.key, ...c.val() }));
        }
        
        function updateHeader() { const now = new Date(); document.getElementById('headerDate').textContent = `${daysFull[now.getDay() === 0 ? 6 : now.getDay() - 1]}, ${now.getDate()} ${months[now.getMonth()]}`; }
        function renderDays() { document.getElementById('daysSelector').innerHTML = days.map((d, i) => `<input type="checkbox" class="day-checkbox" id="day${i+1}" value="${i+1}"><label class="day-label" for="day${i+1}">${d}</label>`).join(''); }
        
        async function toggleQuest(id, isPersistent = false) {
            const today = getDateStr(new Date()), path = isPersistent ? `persistentQuests/${currentUser.odUid}/${id}` : `dailyQuests/${currentUser.odUid}/${today}/${id}`;
            const snap = await db.ref(path).once('value'); const quest = snap.val(); if (!quest || quest.status === 'verified') return;
            let newStatus;
            if (quest.status === 'completed' || quest.status === 'pending_verification') newStatus = 'pending';
            else { newStatus = verifierUid ? 'pending_verification' : 'completed'; playTick(); if (newStatus === 'completed') await addExp(isPersistent ? 50 : 10); }
            await db.ref(path).update({ status: newStatus, completedAt: newStatus !== 'pending' ? Date.now() : null });
            if (isPersistent) await loadPersistent(); else await loadToday();
            if (!verifierUid && newStatus === 'completed') await checkDayComplete();
            await calculateStreak(); renderScreen();
        }
        
        async function checkDayComplete() {
            if (todayQuests.length === 0) return; const allDone = todayQuests.every(q => ['completed','verified'].includes(q.status));
            if (allDone) { const today = getDateStr(new Date()); const snap = await db.ref(`dayRewards/${currentUser.odUid}/day_${today}`).once('value'); if (!snap.exists()) { await addExp(20); await db.ref(`dayRewards/${currentUser.odUid}/day_${today}`).set({ exp: 20 }); celebrate(); } }
        }
        
        async function verifyQuest(userUid, questId, isPersistent, dateStr) {
            const path = isPersistent ? `persistentQuests/${userUid}/${questId}` : `dailyQuests/${userUid}/${dateStr}/${questId}`;
            await db.ref(path).update({ status: 'verified', verifiedAt: Date.now() });
            const uSnap = await db.ref(`users/${userUid}`).once('value'); await db.ref(`users/${userUid}/totalExp`).set((uSnap.val().totalExp || 0) + (isPersistent ? 50 : 10));
            playTick(); await loadUsersToVerify(); renderScreen();
        }
        async function rejectQuest(userUid, questId, isPersistent, dateStr) { const path = isPersistent ? `persistentQuests/${userUid}/${questId}` : `dailyQuests/${userUid}/${dateStr}/${questId}`; await db.ref(path).update({ status: 'pending', completedAt: null }); await loadUsersToVerify(); renderScreen(); }
        async function cancelQuest(userUid, questId, isPersistent, dateStr) { if (!confirm('Tarik balik quest ini?')) return; const path = isPersistent ? `persistentQuests/${userUid}/${questId}` : `dailyQuests/${userUid}/${dateStr}/${questId}`; await db.ref(path).remove(); await loadUsersToVerify(); renderScreen(); }
        async function removeSubordinate(userUid, name) { if (!confirm(`Buang ${name}?`)) return; await db.ref(`users/${userUid}`).update({ verifierUid: null, verifierCode: null }); await loadUsersToVerify(); renderScreen(); }
        async function verifyAll(userUid, dateStr) { const snap = await db.ref(`dailyQuests/${userUid}/${dateStr}`).once('value'); const updates = {}; let count = 0; snap.forEach(c => { if (c.val().status === 'pending_verification') { updates[`${c.key}/status`] = 'verified'; updates[`${c.key}/verifiedAt`] = Date.now(); count++; } }); if (Object.keys(updates).length > 0) { await db.ref(`dailyQuests/${userUid}/${dateStr}`).update(updates); const uSnap = await db.ref(`users/${userUid}`).once('value'); await db.ref(`users/${userUid}/totalExp`).set((uSnap.val().totalExp || 0) + count * 10 + 20); } playTick(); await loadUsersToVerify(); renderScreen(); }
 const snap = await db.ref('users').orderByChild('idCode').equalTo(code).once('value'); if (!snap.exists()) return alert('ID Code tidak dijumpai'); let foundUid = null; snap.forEach(c => foundUid = c.key); if (foundUid === currentUser.odUid) return alert('Tidak boleh jadi pengesah sendiri'); await db.ref(`users/${currentUser.odUid}`).update({ verifierUid: foundUid, verifierCode: code }); verifierUid = foundUid; closeModal('verifierModal'); renderScreen(); }
        async function removeVerifier() { if (!confirm('Buang pengesah?')) return; await db.ref(`users/${currentUser.odUid}`).update({ verifierUid: null, verifierCode: null }); verifierUid = null; renderScreen(); }
        async function changePin() { const current = document.getElementById('currentPinInput').value, newPin = document.getElementById('newPinInput').value; const snap = await db.ref(`users/${currentUser.odUid}/pin`).once('value'); if (snap.val() !== current) return alert('PIN semasa salah'); if (newPin.length !== 4 || !/^\d+$/.test(newPin)) return alert('PIN baru mesti 4 digit'); await db.ref(`users/${currentUser.odUid}/pin`).set(newPin); closeModal('changePinModal'); alert('PIN ditukar'); }
        function logout() { if (!confirm('Log keluar?')) return; localStorage.removeItem('dq_credentials'); location.reload(); }
        
        // Screens
        function switchScreen(screen) { currentScreen = screen; document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.screen === screen)); document.getElementById('fabBtn').classList.toggle('hidden', screen === 'history' || screen === 'settings' || screen === 'stats'); renderScreen(); }
        async function renderScreen() { const el = document.getElementById('mainContent'); switch(currentScreen) { case 'today': el.innerHTML = await renderToday(); break; case 'stats': el.innerHTML = await renderStats(); break; case 'rewards': el.innerHTML = await renderRewards(); break; case 'history': el.innerHTML = await renderHistory(); break; case 'settings': el.innerHTML = await renderSettings(); break; } }
        
        async function renderToday() {
            let html = '';
            if (userStreak > 0) html += `<div class="streak-banner"><span class="streak-icon">üî•</span><div class="streak-info"><div class="streak-count">${userStreak} Hari</div><div class="streak-label">Streak berturut-turut!</div></div></div>`;
            if (usersToVerify.length > 0) html += `<div class="mode-toggle"><button class="mode-btn ${!isVerifierMode ? 'active' : ''}" onclick="isVerifierMode=false;renderScreen()">‚öîÔ∏è Quest Saya</button><button class="mode-btn ${isVerifierMode ? 'active' : ''}" onclick="isVerifierMode=true;renderScreen()">‚úÖ Pengesah ${pendingCount > 0 ? `<span class="badge">${pendingCount}</span>` : ''}</button></div>`;
            if (isVerifierMode) return html + await renderVerifier();
            const done = todayQuests.filter(q => ['completed','pending_verification','verified'].includes(q.status)).length, total = todayQuests.length, pct = total ? (done/total*100) : 0;
            const dow = new Date().getDay(), adjToday = dow === 0 ? 7 : dow;
            const weekHtml = days.map((d,i) => `<div class="week-day ${(i+1) < adjToday ? 'completed' : (i+1) === adjToday ? 'today' : 'future'}"><div>${d}</div><div>${(i+1) < adjToday ? '‚úì' : (i+1) === adjToday ? 'üìç' : '¬∑'}</div></div>`).join('');
            html += `<div class="progress-section"><div class="progress-header"><span class="progress-title">Quest Hari Ini</span><span class="progress-count">${done}/${total}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div class="week-summary">${weekHtml}</div></div>`;
            if (persistentQuests.length > 0) { html += `<div class="section-header"><h3 class="section-title">üìå Berterusan</h3></div><div class="quest-list">`; persistentQuests.forEach(q => { html += `<div class="quest-item persistent ${q.status}" onclick="toggleQuest('${q.id}',true)"><div class="quest-checkbox"></div><div class="quest-content"><div class="quest-title">${q.title}</div><div class="quest-meta"><span class="quest-category category-${q.category}">${getCatIcon(q.category)}</span><span class="exp-reward">+50 EXP</span></div></div></div>`; }); html += '</div>'; }
            if (todayQuests.length > 0) { html += `<div class="section-header" style="margin-top:20px"><h3 class="section-title">üìÖ Hari Ini</h3></div><div class="quest-list">`; todayQuests.forEach(q => { const badge = q.status === 'pending_verification' ? '<span style="color:var(--warning);font-size:11px;margin-left:8px">‚è≥</span>' : q.status === 'verified' ? '<span style="color:var(--success);font-size:11px;margin-left:8px">‚úì‚úì</span>' : ''; html += `<div class="quest-item ${q.status}" onclick="toggleQuest('${q.id}')"><div class="quest-checkbox"></div><div class="quest-content"><div class="quest-title">${q.title}${badge}</div><div class="quest-meta"><span class="quest-category category-${q.category}">${getCatIcon(q.category)}</span><span class="exp-reward">+10 EXP</span></div></div></div>`; }); html += '</div>'; }
            if (todayQuests.length === 0 && persistentQuests.length === 0) html += `<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Tiada quest</div></div>`;
            return html;
        }
        
        async function renderVerifier() {
            if (usersToVerify.length === 0) return `<div class="empty-state"><div class="empty-icon">üëÅÔ∏è</div><div class="empty-title">Tiada anak buah</div></div>`;
            const today = getDateStr(new Date()); let html = '';
            for (const u of usersToVerify) {
                const qSnap = await db.ref(`dailyQuests/${u.odUid}/${today}`).once('value'); const quests = []; qSnap.forEach(c => quests.push({ id: c.key, ...c.val() }));
                const pSnap = await db.ref(`persistentQuests/${u.odUid}`).once('value'); const pQuests = []; pSnap.forEach(c => pQuests.push({ id: c.key, ...c.val() }));
                const rSnap = await db.ref(`pendingRewards/${u.odUid}`).once('value'); const pRewards = []; rSnap.forEach(c => pRewards.push({ id: c.key, ...c.val() }));
                const rwSnap = await db.ref(`rewards/${u.odUid}`).once('value'); const uRewards = []; rwSnap.forEach(c => uRewards.push({ id: c.key, ...c.val() }));
                const pending = quests.filter(q => q.status === 'pending_verification').length + pQuests.filter(q => q.status === 'pending_verification').length + pRewards.length;
                html += `<div class="verify-card"><div class="verify-header"><div class="verify-user"><span style="font-size:24px">üë§</span><div><div class="verify-name">${u.displayName || u.email}</div><div class="verify-count">${pending} menunggu</div></div></div><button class="btn-icon btn-reject" onclick="removeSubordinate('${u.odUid}','${u.displayName}')">üëã</button></div>`;
                html += `<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary btn-sm" style="flex:1" onclick="openAssign('${u.odUid}','${u.displayName}')">‚ûï Quest</button>${quests.filter(q=>q.status==='pending_verification').length > 0 ? `<button class="btn btn-primary btn-sm" style="flex:1" onclick="verifyAll('${u.odUid}','${today}')">‚úì Semua</button>` : ''}</div>`;
                if (pRewards.length > 0) { html += '<div style="font-size:11px;color:var(--warning);font-weight:600;margin-bottom:8px">üéÅ Rewards Menunggu</div>'; pRewards.forEach(r => { html += `<div class="verify-quest"><div class="verify-quest-info"><span>${r.icon}</span><span>${r.title}</span><span style="color:var(--purple);font-size:12px;margin-left:8px">-${r.cost} EXP</span></div><div class="verify-actions"><button class="btn-icon btn-verify" onclick="approveReward('${u.odUid}','${r.id}')">‚úì</button><button class="btn-icon btn-reject" onclick="rejectReward('${u.odUid}','${r.id}',${r.cost})">‚úó</button></div></div>`; }); }
                if (uRewards.length > 0) { html += '<div style="font-size:11px;color:var(--purple);font-weight:600;margin:8px 0">üéÅ Rewards Anak Buah <button class="btn-sm btn-secondary" style="padding:4px 8px;font-size:10px" onclick="openRewardModalForUser(\''+u.odUid+'\')">+ Tambah</button></div>'; uRewards.forEach(r => { html += `<div class="verify-quest"><div class="verify-quest-info"><span>${r.icon}</span><span>${r.title}</span><span style="color:var(--purple);font-size:12px;margin-left:8px">${r.cost} EXP</span></div><div class="verify-actions"><button class="btn-icon" style="background:#f0f0f0" onclick="editRewardForUser('${u.odUid}','${r.id}','${r.title}',${r.cost},'${r.icon}')">‚úèÔ∏è</button><button class="btn-icon" style="background:#fff0f0;color:var(--danger)" onclick="deleteReward('${r.id}','${u.odUid}')">üóëÔ∏è</button></div></div>`; }); }
                if (pQuests.length > 0) { html += '<div style="font-size:11px;color:var(--persistent);font-weight:600;margin:8px 0">üìå Berterusan</div>'; pQuests.forEach(q => { const isPending = q.status === 'pending_verification'; html += `<div class="verify-quest"><div class="verify-quest-info"><span>${getCatIcon(q.category)}</span><span>${q.title}</span><span style="margin-left:8px">${isPending ? '‚è≥' : q.status === 'verified' ? '‚úì‚úì' : ''}</span></div><div class="verify-actions">${isPending ? `<button class="btn-icon btn-verify" onclick="verifyQuest('${u.odUid}','${q.id}',true,'')">‚úì</button><button class="btn-icon btn-reject" onclick="rejectQuest('${u.odUid}','${q.id}',true,'')">‚úó</button>` : ''}<button class="btn-icon" style="background:#fff0f0;color:var(--danger)" onclick="cancelQuest('${u.odUid}','${q.id}',true,'')">üóëÔ∏è</button></div></div>`; }); }
                if (quests.length > 0) { html += '<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin:8px 0">üìÖ Harian</div>'; quests.forEach(q => { const isPending = q.status === 'pending_verification'; html += `<div class="verify-quest"><div class="verify-quest-info"><span>${getCatIcon(q.category)}</span><span>${q.title}</span><span style="margin-left:8px">${isPending ? '‚è≥' : q.status === 'verified' ? '‚úì‚úì' : q.status === 'completed' ? '‚úì' : ''}</span></div><div class="verify-actions">${isPending ? `<button class="btn-icon btn-verify" onclick="verifyQuest('${u.odUid}','${q.id}',false,'${today}')">‚úì</button><button class="btn-icon btn-reject" onclick="rejectQuest('${u.odUid}','${q.id}',false,'${today}')">‚úó</button>` : ''}<button class="btn-icon" style="background:#fff0f0;color:var(--danger)" onclick="cancelQuest('${u.odUid}','${q.id}',false,'${today}')">üóëÔ∏è</button></div></div>`; }); }
                html += '</div>';
            }
            return html;
        }
        
        function openRewardModalForUser(userUid) { editingRewardId = null; editingRewardUserUid = userUid; document.getElementById('rewardModalTitle').textContent = 'Tambah Reward'; document.getElementById('rewardTitle').value = ''; document.getElementById('rewardCost').value = ''; selectedRewardIcon = 'üéÅ'; document.querySelectorAll('.reward-icon-btn').forEach(b => b.classList.remove('selected')); openModal('rewardModal'); }
        function editRewardForUser(userUid, rewardId, title, cost, icon) { editingRewardId = rewardId; editingRewardUserUid = userUid; document.getElementById('rewardModalTitle').textContent = 'Edit Reward'; document.getElementById('rewardTitle').value = title; document.getElementById('rewardCost').value = cost; selectRewardIcon(icon); openModal('rewardModal'); }
        
        async function renderStats() {
            const today = new Date(); let weeklyExp = 0, totalCompleted = 0, weeklyDays = [];
            const catCount = { home: 0, work: 0, health: 0, finance: 0, learning: 0, personal: 0 };
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today); d.setDate(today.getDate() - i); const dateStr = getDateStr(d);
                const snap = await db.ref(`dailyQuests/${currentUser.odUid}/${dateStr}`).once('value');
                let dayDone = 0, dayTotal = 0;
                snap.forEach(c => { const q = c.val(); dayTotal++; if (['completed','pending_verification','verified'].includes(q.status)) { dayDone++; totalCompleted++; if (catCount[q.category] !== undefined) catCount[q.category]++; weeklyExp += 10; } });
                weeklyDays.push({ day: days[(d.getDay() + 6) % 7], done: dayDone, total: dayTotal });
            }
            let totalQuests = 0, completedQuests = 0;
            for (const wd of weeklyDays) { totalQuests += wd.total; completedQuests += wd.done; }
            const completionRate = totalQuests > 0 ? Math.round(completedQuests / totalQuests * 100) : 0;
            const totalCatCount = Object.values(catCount).reduce((a,b) => a+b, 0);
            let html = `<div class="stats-grid"><div class="stat-card streak"><div class="stat-icon">üî•</div><div class="stat-value">${userStreak}</div><div class="stat-label">Hari Streak</div></div><div class="stat-card exp"><div class="stat-icon">‚ö°</div><div class="stat-value">${weeklyExp}</div><div class="stat-label">EXP Minggu Ini</div></div><div class="stat-card rate"><div class="stat-icon">üìà</div><div class="stat-value">${completionRate}%</div><div class="stat-label">Completion Rate</div></div><div class="stat-card quests"><div class="stat-icon">‚úÖ</div><div class="stat-value">${totalCompleted}</div><div class="stat-label">Quest Minggu Ini</div></div></div>`;
            html += `<div class="chart-section"><div class="chart-title">üìä Quest Diselesaikan (7 Hari)</div><div class="chart-bars">${weeklyDays.map(wd => { const h = wd.total > 0 ? (wd.done / wd.total * 100) : 0; return `<div class="chart-bar-wrap"><div class="chart-bar-value">${wd.done}</div><div class="chart-bar" style="height:${Math.max(h, 5)}%"></div><div class="chart-bar-label">${wd.day}</div></div>`; }).join('')}</div></div>`;
            html += `<div class="chart-section"><div class="chart-title">üè∑Ô∏è Kategori Terbanyak</div><div class="category-stats">`;
            Object.entries(catCount).sort((a,b) => b[1] - a[1]).forEach(([cat, count]) => { const pct = totalCatCount > 0 ? (count / totalCatCount * 100) : 0; html += `<div class="category-stat"><span style="font-size:20px">${getCatIcon(cat)}</span><div class="category-stat-bar"><div class="category-stat-fill" style="width:${pct}%;background:${getCatColor(cat)}"></div></div><span class="category-stat-count">${count}</span></div>`; });
            html += `</div></div><div class="chart-section"><div class="chart-title">üèÜ Achievements</div>`;
            const achievements = [{ icon: 'üî•', title: 'On Fire', desc: '7 hari streak', unlocked: userStreak >= 7, progress: `${Math.min(userStreak, 7)}/7` }, { icon: '‚ö°', title: 'Power Up', desc: 'Capai Level 5', unlocked: userLevel >= 5, progress: `Level ${userLevel}/5` }, { icon: 'üíØ', title: 'Centurion', desc: '100 quest selesai', unlocked: totalCompleted >= 100, progress: `${totalCompleted}/100` }, { icon: 'üåü', title: 'Dedicated', desc: '30 hari streak', unlocked: userStreak >= 30, progress: `${Math.min(userStreak, 30)}/30` }];
            achievements.forEach(a => { html += `<div class="achievement-item ${a.unlocked ? '' : 'locked'}"><span class="achievement-icon">${a.icon}</span><div class="achievement-content"><div class="achievement-title">${a.title}</div><div class="achievement-desc">${a.desc}</div><div class="achievement-progress">${a.unlocked ? '‚úÖ Unlocked!' : a.progress}</div></div></div>`; });
            return html + '</div>';
        }
        
        async function renderRewards() {
            const levelData = calculateLevel(userExp);
            let html = `<div class="rewards-balance"><div class="balance-label">EXP Tersedia</div><div class="balance-value">${userExp}</div><div class="balance-sub">Level ${userLevel} ‚Ä¢ ${levelData.needed - levelData.current} EXP ke Level ${userLevel + 1}</div></div>`;
            if (pendingRewards.length > 0) { html += `<div class="pending-rewards"><div class="pending-title">‚è≥ Menunggu Pengesahan</div>`; pendingRewards.forEach(r => { html += `<div class="pending-item"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">${r.icon}</span><span>${r.title}</span></div><span style="color:var(--purple);font-weight:600">-${r.cost} EXP</span></div>`; }); html += '</div>'; }
            html += `<div class="section-header"><h3 class="section-title">üéÅ Rewards</h3></div>`;
            if (rewards.length === 0) html += `<div class="empty-state" style="padding:20px"><div class="empty-icon">üéÅ</div><div class="empty-title">Tiada reward</div><p style="color:var(--text-muted);margin-top:8px">Tekan + untuk tambah</p></div>`;
            else rewards.forEach(r => { const canAfford = userExp >= r.cost; html += `<div class="reward-item"><span class="reward-icon">${r.icon}</span><div class="reward-content"><div class="reward-title">${r.title}</div><div class="reward-cost">${r.cost} EXP</div></div><button class="reward-btn ${canAfford ? 'can-afford' : 'cannot-afford'}" onclick="${canAfford ? `claimReward('${r.id}')` : ''}">${canAfford ? 'Tebus' : 'üîí'}</button><button class="btn-icon" style="background:#f0f0f0;margin-left:8px" onclick="openRewardModal('${r.id}')">‚úèÔ∏è</button><button class="btn-icon" style="background:#fff0f0;color:var(--danger);margin-left:4px" onclick="deleteReward('${r.id}')">üóëÔ∏è</button></div>`; });
            return html;
        }
        
        async function renderHistory() {
            const today = new Date(), firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            let html = `<div class="section-header"><h3 class="section-title">${months[today.getMonth()]} ${today.getFullYear()}</h3></div>`;
            const pSnap = await db.ref(`persistentQuests/${currentUser.odUid}`).once('value'); const completedPersistent = []; pSnap.forEach(c => { const q = c.val(); if (q.status === 'completed' || q.status === 'verified') completedPersistent.push({ id: c.key, ...q }); });
            if (completedPersistent.length > 0) { html += `<div class="history-item" style="border-left:4px solid var(--persistent)"><div class="history-header" onclick="this.nextElementSibling.classList.toggle('hidden')"><div class="history-left"><span style="font-size:20px">üìå</span><div><div class="history-date">Quest Berterusan Selesai</div><div class="history-summary success">${completedPersistent.length} quest</div></div></div><span class="exp-reward">+${completedPersistent.length * 50} EXP</span></div><div class="history-details hidden">${completedPersistent.map(q => { const d = q.completedAt ? new Date(q.completedAt) : null; return `<div class="history-quest"><span class="history-check done">‚úì</span><span>${getCatIcon(q.category)}</span><span>${q.title}</span><span style="margin-left:auto;font-size:11px;color:var(--text-muted)">${d ? d.getDate() + ' ' + months[d.getMonth()] : ''}</span></div>`; }).join('')}</div></div>`; }
            let hasDaily = false;
            for (let d = new Date(today); d >= firstDay; d.setDate(d.getDate() - 1)) { const dateStr = getDateStr(d); const snap = await db.ref(`dailyQuests/${currentUser.odUid}/${dateStr}`).once('value'); if (!snap.exists()) continue; hasDaily = true; const quests = []; snap.forEach(c => quests.push(c.val())); const done = quests.filter(q => ['completed','pending_verification','verified'].includes(q.status)).length, total = quests.length, allDone = done === total && total > 0, isToday = dateStr === getDateStr(today); html += `<div class="history-item"><div class="history-header" onclick="this.nextElementSibling.classList.toggle('hidden')"><div class="history-left"><span style="font-size:20px">${allDone ? '‚úÖ' : '‚è≥'}</span><div><div class="history-date">${daysFull[d.getDay()===0?6:d.getDay()-1]}, ${d.getDate()} ${months[d.getMonth()]}${isToday?' (Hari Ini)':''}</div><div class="history-summary ${allDone?'success':'pending'}">${done}/${total} selesai</div></div></div>${allDone ? `<span class="exp-reward">+${total*10+20} EXP</span>` : ''}</div><div class="history-details hidden">${quests.map(q => `<div class="history-quest"><span class="history-check ${['completed','pending_verification','verified'].includes(q.status)?'done':'undone'}">${['completed','pending_verification','verified'].includes(q.status)?'‚úì':'‚óã'}</span><span>${getCatIcon(q.category)}</span><span>${q.title}</span></div>`).join('')}</div></div>`; }
            if (completedPersistent.length === 0 && !hasDaily) return `<div class="section-header"><h3 class="section-title">${months[today.getMonth()]} ${today.getFullYear()}</h3></div><div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Tiada sejarah</div></div>`;
            return html;
        }
        
        async function renderSettings() {
            const snap = await db.ref(`users/${currentUser.odUid}`).once('value'); const data = snap.val() || {}; const levelData = calculateLevel(userExp);
            return `<div class="settings-section"><div class="settings-title">Akaun</div><div class="settings-item"><span class="settings-label">${data.displayName || 'User'}</span></div><div class="settings-item"><span class="settings-label">Email</span><span class="settings-value">${data.email || '-'}</span></div></div>
            <div class="settings-section"><div class="settings-title">üÜî ID Code</div><div class="id-code-box"><div class="id-code-label">Kongsi untuk link akaun</div><div class="id-code-value">${currentUser.idCode}</div></div></div>
            <div class="settings-section"><div class="settings-title">üìä Level & EXP</div><div class="settings-item"><span class="settings-label">Level</span><span class="settings-value" style="color:var(--purple);font-weight:700">${userLevel}</span></div><div class="settings-item"><span class="settings-label">Total EXP</span><span class="settings-value">${userExp}</span></div><div class="settings-item"><span class="settings-label">Seterusnya</span><span class="settings-value">${levelData.needed - levelData.current} EXP lagi</span></div></div>
            <div class="settings-section"><div class="settings-title">üìã Quest Templates</div>${questTemplates.length === 0 ? '<p style="color:var(--text-muted);font-size:13px">Tiada template</p>' : questTemplates.map(t => `<div class="settings-item"><span class="settings-label">${getCatIcon(t.category)} ${t.title}</span><div style="display:flex;gap:8px"><button class="btn-icon" style="background:#f0f0f0" onclick="editTemplate('${t.id}')">‚úèÔ∏è</button><button class="btn-icon" style="background:#fff0f0;color:var(--danger)" onclick="openDelete('${t.id}','template')">üóëÔ∏è</button></div></div>`).join('')}</div>
            <div class="settings-section"><div class="settings-title">üëÅÔ∏è Pengesah</div>${verifierUid ? `<div class="settings-item"><span class="settings-label">Ada pengesah</span><button class="btn btn-danger btn-sm" onclick="removeVerifier()">Buang</button></div>` : `<div class="settings-item"><span class="settings-label">Tiada pengesah</span><button class="btn btn-primary btn-sm" onclick="openModal('verifierModal')">Tambah</button></div>`}</div>
            <div class="settings-section"><div class="settings-title">üîê Keselamatan</div><div class="settings-item"><span class="settings-label">PIN</span><button class="btn btn-secondary btn-sm" onclick="openModal('changePinModal')">Tukar</button></div></div>
            <button class="btn btn-danger" onclick="logout()" style="margin-top:20px">Log Keluar</button>`;
        }
        
        // Sound & Effects
        const AudioCtx = window.AudioContext || window.webkitAudioContext; let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new AudioCtx(); }
        function playTick() { initAudio(); const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
        function playLevelUp() { initAudio(); [523, 659, 784, 1047].forEach((f, i) => { const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(f, audioCtx.currentTime + i*0.15); gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i*0.15); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.15 + 0.3); osc.start(audioCtx.currentTime + i*0.15); osc.stop(audioCtx.currentTime + i*0.15 + 0.3); }); }
        function celebrate() { const el = document.getElementById('celebration'), colors = ['#00b894','#55efc4','#ffd700','#fd79a8','#a29bfe','#ff6b6b']; for (let i = 0; i < 50; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random()*100 + '%'; c.style.background = colors[Math.floor(Math.random()*colors.length)]; c.style.animationDelay = Math.random()*0.5 + 's'; el.appendChild(c); setTimeout(() => c.remove(), 3000); } }
        
        checkSavedLogin();
    </script>
</body>
</html>
