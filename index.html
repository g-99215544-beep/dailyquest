<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quest</title>
    <meta name="theme-color" content="#00b894">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Daily Quest">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #00b894;
            --primary-dark: #00a381;
            --primary-light: #55efc4;
            --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e8f5e9 50%, #f1f8f4 100%);
            --bg-card: #ffffff;
            --text-dark: #2d3436;
            --text-muted: #636e72;
            --success: #00b894;
            --danger: #e74c3c;
            --warning: #f39c12;
            --persistent: #9b59b6;
            --persistent-light: #f5eef8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-dark);
            min-height: 100vh;
            background-attachment: fixed;
        }
        .app-container { max-width: 480px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; text-align: center; padding: 24px; background: var(--bg-gradient);
        }
        .login-logo {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 48px; margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 184, 148, 0.3);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .login-title { font-family: 'Cinzel', serif; font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; font-size: 14px; }
        .login-methods { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 12px; }
        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            background: white; color: #333; border: none; padding: 14px 32px;
            border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%;
        }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .google-btn svg { width: 24px; height: 24px; }
        .divider { display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 13px; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #ddd; }
        .password-login { display: flex; flex-direction: column; gap: 10px; }
        .password-input {
            padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 16px; font-family: inherit; text-align: center; transition: all 0.2s;
        }
        .password-input:focus { outline: none; border-color: var(--primary); }
        .password-btn {
            padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding: 16px; background: var(--bg-card);
            border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .header-left h1 { font-family: 'Cinzel', serif; font-size: 20px; color: var(--primary); margin-bottom: 4px; }
        .header-date { font-size: 13px; color: var(--text-muted); }
        .level-display {
            display: flex; align-items: center; gap: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 8px 14px; border-radius: 16px; color: white;
        }
        .level-badge {
            width: 32px; height: 32px; background: rgba(255,255,255,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }
        .level-info { display: flex; flex-direction: column; }
        .level-text { font-size: 11px; opacity: 0.9; }
        .exp-bar { width: 60px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .exp-fill { height: 100%; background: #ffd700; border-radius: 3px; transition: width 0.5s ease; }
        .mode-toggle { display: flex; background: #f0f0f0; border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .mode-btn {
            flex: 1; padding: 10px 16px; border: none; background: transparent;
            border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .mode-btn .badge { background: var(--danger); color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; }
        .progress-section {
            background: var(--bg-card); border-radius: 20px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .progress-title { font-weight: 600; font-size: 14px; color: #555; }
        .progress-count { color: var(--primary); font-weight: 700; }
        .progress-bar { height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 6px; transition: width 0.5s ease;
        }
        .week-summary { display: flex; justify-content: space-between; gap: 6px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0; }
        .week-day { flex: 1; text-align: center; padding: 8px 4px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .week-day.completed { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); color: #2d7a3a; }
        .week-day.today { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .week-day.future { background: #f5f5f5; color: #aaa; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { font-family: 'Cinzel', serif; font-size: 16px; color: var(--primary); }
        .quest-list { display: flex; flex-direction: column; gap: 10px; }
        .quest-item {
            background: var(--bg-card); border-radius: 16px; padding: 16px;
            display: flex; align-items: center; gap: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; cursor: pointer;
        }
        .quest-item:hover { transform: translateX(4px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .quest-item.completed { opacity: 0.7; background: #f8fff8; }
        .quest-item.completed .quest-title { text-decoration: line-through; color: #888; }
        .quest-item.verified { background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%); border: 2px solid var(--success); }
        .quest-item.pending_verification { background: #fffbf0; border: 2px solid var(--warning); }
        .quest-item.persistent {
            background: linear-gradient(135deg, var(--persistent-light) 0%, #f5eef8 100%);
            border-left: 4px solid var(--persistent);
        }
        .quest-checkbox {
            width: 28px; height: 28px; border: 2px solid #ddd; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.3s ease;
        }
        .quest-item.completed .quest-checkbox,
        .quest-item.pending_verification .quest-checkbox,
        .quest-item.verified .quest-checkbox { background: var(--success); border-color: var(--success); }
        .quest-checkbox::after { content: '‚úì'; color: white; font-weight: bold; opacity: 0; transform: scale(0); transition: all 0.2s ease; }
        .quest-item.completed .quest-checkbox::after,
        .quest-item.pending_verification .quest-checkbox::after,
        .quest-item.verified .quest-checkbox::after { opacity: 1; transform: scale(1); }
        .quest-content { flex: 1; }
        .quest-title { font-weight: 600; margin-bottom: 4px; font-size: 15px; color: #444; }
        .quest-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px; }
        .quest-category { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .category-home { background: #ffebee; color: #c62828; }
        .category-work { background: #e3f2fd; color: #1565c0; }
        .category-health { background: #e8f5e9; color: #2e7d32; }
        .category-finance { background: #fff8e1; color: #f57f17; }
        .category-learning { background: #f3e5f5; color: #7b1fa2; }
        .category-personal { background: #fce4ec; color: #c2185b; }
        .exp-reward {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
        }
        .persistent-badge { background: var(--persistent); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
        .pending-badge { background: rgba(243, 156, 18, 0.2); color: #d68910; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .verified-badge { background: rgba(0, 184, 148, 0.2); color: var(--success); padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-title { font-size: 18px; margin-bottom: 8px; color: #666; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around;
            padding: 12px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: none; border: none; color: #aaa; font-size: 11px;
            cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.2s;
        }
        .nav-item.active { color: var(--primary); background: rgba(0, 184, 148, 0.1); }
        .nav-icon { font-size: 20px; }
        .fab {
            position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none; border-radius: 50%; color: white; font-size: 28px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.4); transition: all 0.3s ease; z-index: 100;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: flex-end; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-card); width: 100%; max-width: 480px; max-height: 90vh;
            border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%);
            transition: transform 0.3s ease; overflow-y: auto;
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-family: 'Cinzel', serif; font-size: 20px; color: var(--primary); }
        .modal-close { background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #555; }
        .form-input, .form-select {
            width: 100%; padding: 14px 16px; background: #f9f9f9; border: 2px solid #eee;
            border-radius: 12px; color: #444; font-size: 16px; font-family: inherit; transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); background: white; }
        .quest-type-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .quest-type-btn {
            flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px;
            background: white; cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .quest-type-btn.active { border-color: var(--primary); background: rgba(0, 184, 148, 0.1); }
        .quest-type-btn.persistent.active { border-color: var(--persistent); background: var(--persistent-light); }
        .quest-type-btn span { display: block; font-size: 20px; margin-bottom: 4px; }
        .quest-type-btn small { font-size: 12px; color: var(--text-muted); }
        .days-selector { display: flex; flex-wrap: wrap; gap: 8px; }
        .day-checkbox { display: none; }
        .day-label {
            padding: 10px 14px; background: #f5f5f5; border: 2px solid #eee;
            border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; transition: all 0.2s;
        }
        .day-checkbox:checked + .day-label { background: var(--primary); border-color: var(--primary); color: white; }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-family: inherit;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4); }
        .btn-danger { background: #fff0f0; color: var(--danger); }
        .btn-secondary { background: #f5f5f5; color: #666; }
        .btn-sm { padding: 10px 16px; font-size: 14px; width: auto; }
        .btn-group { display: flex; gap: 12px; margin-top: 16px; }
        .btn-group .btn { flex: 1; }
        .settings-section { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .settings-title { font-weight: 700; margin-bottom: 16px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .settings-item:last-child { border-bottom: none; }
        .settings-item-label { font-weight: 600; color: var(--text-dark); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 12px 0; }
        .user-avatar {
            width: 48px; height: 48px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .user-name { font-weight: 700; color: #444; }
        .user-email { font-size: 13px; color: #888; }
        .id-code-display { background: #f5f5f5; border-radius: 12px; padding: 16px; text-align: center; }
        .id-code { font-family: 'Courier New', monospace; font-size: 24px; font-weight: 700; color: var(--primary); letter-spacing: 4px; }
        .id-code-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .copy-btn { margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .lang-toggle { display: flex; gap: 8px; }
        .lang-btn { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .lang-btn.active { border-color: var(--primary); background: rgba(0, 184, 148, 0.1); color: var(--primary); }
        .verify-user-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .verify-user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
        .verify-user-info { display: flex; align-items: center; gap: 10px; }
        .verify-user-name { font-weight: 700; }
        .verify-user-count { font-size: 12px; color: var(--text-muted); }
        .verify-quest-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
        .verify-quest-item:last-child { border-bottom: none; }
        .verify-quest-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .verify-quest-actions { display: flex; gap: 8px; }
        .btn-icon { width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-verify { background: rgba(0, 184, 148, 0.2); color: var(--success); }
        .btn-verify:hover { background: var(--success); color: white; }
        .btn-reject { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .btn-reject:hover { background: var(--danger); color: white; }
        .template-item { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .template-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .template-title { font-weight: 700; margin-bottom: 4px; }
        .template-days { display: flex; gap: 6px; margin-top: 10px; }
        .template-day { padding: 4px 8px; background: #f0f0f0; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .quest-actions { display: flex; gap: 8px; }
        .quest-action-btn { background: none; border: none; font-size: 16px; cursor: pointer; padding: 4px; opacity: 0.6; transition: opacity 0.2s; }
        .quest-action-btn:hover { opacity: 1; }
        .history-item { background: var(--bg-card); border-radius: 16px; padding: 0; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; cursor: pointer; }
        .history-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; }
        .history-left { display: flex; align-items: center; gap: 12px; }
        .history-status-icon { font-size: 20px; }
        .history-info { display: flex; flex-direction: column; gap: 2px; }
        .history-date-text { font-weight: 700; font-size: 14px; }
        .history-summary { font-size: 12px; font-weight: 600; }
        .history-summary.success { color: var(--success); }
        .history-summary.failed { color: var(--danger); }
        .history-summary.pending { color: var(--warning); }
        .history-right { display: flex; align-items: center; gap: 10px; }
        .history-arrow { color: var(--text-muted); font-size: 12px; }
        .history-exp { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 12px; padding: 4px 10px; border-radius: 8px; font-weight: 600; }
        .history-details { border-top: 1px solid rgba(0,0,0,0.05); padding: 12px 16px; background: rgba(0,0,0,0.02); }
        .history-quest-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 14px; }
        .history-quest-item:not(:last-child) { border-bottom: 1px solid rgba(0,0,0,0.04); }
        .history-quest-check { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 12px; font-weight: bold; }
        .history-quest-item.done .history-quest-check { background: var(--success); color: white; }
        .history-quest-item.undone .history-quest-check { background: #e0e0e0; color: #999; }
        .verifier-status { background: #fffbf0; border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; border: 1px solid rgba(243, 156, 18, 0.3); }
        .verifier-status-info { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .celebration { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; animation: fall 3s ease-out forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-logo">üìú</div>
        <h1 class="login-title">Daily Quest</h1>
        <p class="login-subtitle">Gamify tugasan harian anda</p>
        <div class="login-methods">
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                <span>Log masuk dengan Google</span>
            </button>
            <div class="divider">atau</div>
            <div class="password-login">
                <input type="password" class="password-input" id="passwordInput" placeholder="Masukkan kata laluan">
                <button class="password-btn" onclick="signInWithPassword()">Masuk</button>
            </div>
        </div>
    </div>
    <div id="mainApp" class="hidden">
        <div class="app-container">
            <header class="header">
                <div class="header-left">
                    <h1>Daily Quest</h1>
                    <div class="header-date" id="headerDate"></div>
                </div>
                <div class="header-right">
                    <div class="level-display">
                        <div class="level-badge" id="levelBadge">1</div>
                        <div class="level-info">
                            <span class="level-text">Level <span id="levelNum">1</span></span>
                            <div class="exp-bar"><div class="exp-fill" id="expFill" style="width: 0%"></div></div>
                        </div>
                    </div>
                </div>
            </header>
            <main id="mainContent"></main>
        </div>
        <button class="fab" id="fabBtn" onclick="openAddQuestModal()">+</button>
        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="today" onclick="switchScreen('today')"><span class="nav-icon">‚öîÔ∏è</span><span>Hari Ini</span></button>
            <button class="nav-item" data-screen="quests" onclick="switchScreen('quests')"><span class="nav-icon">üìã</span><span>Quest</span></button>
            <button class="nav-item" data-screen="history" onclick="switchScreen('history')"><span class="nav-icon">üìú</span><span>Sejarah</span></button>
            <button class="nav-item" data-screen="settings" onclick="switchScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span><span>Tetapan</span></button>
        </nav>
    </div>
    <div class="modal-overlay" id="questModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="questModalTitle">Tambah Quest</h2>
                <button class="modal-close" onclick="closeQuestModal()">√ó</button>
            </div>
            <form id="questForm" onsubmit="saveQuest(event)">
                <input type="hidden" id="questId">
                <div class="quest-type-toggle">
                    <button type="button" class="quest-type-btn active" id="dailyTypeBtn" onclick="setQuestType('daily')"><span>üìÖ</span><small>Harian</small></button>
                    <button type="button" class="quest-type-btn persistent" id="persistentTypeBtn" onclick="setQuestType('persistent')"><span>üìå</span><small>Berterusan</small></button>
                </div>
                <div class="form-group">
                    <label class="form-label">Tajuk Quest</label>
                    <input type="text" class="form-input" id="questTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <select class="form-select" id="questCategory">
                        <option value="home">üè† Rumah</option>
                        <option value="work">üíº Kerja</option>
                        <option value="health">üí™ Kesihatan</option>
                        <option value="finance">üí∞ Kewangan</option>
                        <option value="learning">üìö Pembelajaran</option>
                        <option value="personal">üéØ Peribadi</option>
                    </select>
                </div>
                <div class="form-group" id="daysGroup">
                    <label class="form-label">Ulang pada Hari</label>
                    <div class="days-selector" id="daysSelector"></div>
                </div>
                <button type="submit" class="btn btn-primary">Simpan</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Sahkan Padam</h2>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <p>Adakah anda pasti mahu padam quest ini?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Batal</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Padam</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="verifierModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Tambah Pengesah</h2>
                <button class="modal-close" onclick="closeVerifierModal()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">ID Code Pengesah</label>
                <input type="text" class="form-input" id="verifierCodeInput" placeholder="Contoh: ABC123" style="text-transform: uppercase;">
            </div>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Minta ID Code dari orang yang akan sahkan quest anda</p>
            <button class="btn btn-primary" onclick="addVerifierByCode()">Tambah</button>
        </div>
    </div>
    <div class="celebration" id="celebration"></div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzjLQqOFHFKLescOm3XeNtP5vceNInW6s",
            authDomain: "dailyquest-e7d7b.firebaseapp.com",
            projectId: "dailyquest-e7d7b",
            storageBucket: "dailyquest-e7d7b.firebasestorage.app",
            messagingSenderId: "372073463598",
            appId: "1:372073463598:web:22aaa1c892a2256369c4bf",
            databaseURL: "https://dailyquest-e7d7b-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const PASSWORD_ACCOUNTS = {
            'hanis123': { odUid: 'hanis_account_001', displayName: 'Hanis', email: 'hanis@dailyquest.app' }
        };

        let currentUser = null, currentScreen = 'today', userLevel = 1, userExp = 0;
        let questTemplates = [], todayQuests = [], persistentQuests = [];
        let deleteTarget = null, verifierCode = null, verifierUid = null;
        let isVerifierMode = false, usersToVerify = [], pendingVerifyCount = 0, questType = 'daily';
        const days = ['Isn', 'Sel', 'Rab', 'Kha', 'Jum', 'Sab', 'Ahd'];
        const daysFull = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'];
        const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];

        function getExpForLevel(level) { return level * 100; }
        function calculateLevel(totalExp) {
            let level = 1, expNeeded = getExpForLevel(level), remainingExp = totalExp;
            while (remainingExp >= expNeeded) { remainingExp -= expNeeded; level++; expNeeded = getExpForLevel(level); }
            return { level, currentExp: remainingExp, expNeeded };
        }
        function updateLevelDisplay() {
            const levelData = calculateLevel(userExp);
            userLevel = levelData.level;
            document.getElementById('levelBadge').textContent = userLevel;
            document.getElementById('levelNum').textContent = userLevel;
            document.getElementById('expFill').style.width = (levelData.currentExp / levelData.expNeeded * 100) + '%';
        }
        function generateIdCode(uid) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars.charAt((uid.charCodeAt(i % uid.length) + i * 7) % chars.length);
            return code;
        }

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }
        function playTickSound() {
            initAudio();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.type = 'sine'; osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.15);
        }
        function playLevelUpSound() {
            initAudio();
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i * 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.3);
                osc.type = 'sine'; osc.start(audioCtx.currentTime + i * 0.15); osc.stop(audioCtx.currentTime + i * 0.15 + 0.3);
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) { currentUser = user; showApp(); }
            else if (currentUser && currentUser.isPasswordUser) showApp();
            else { currentUser = null; hideApp(); }
        });
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initializeApp();
        }
        function hideApp() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        function signInWithGoogle() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert('Login gagal: ' + e.message));
        }
        function signInWithPassword() {
            const pw = document.getElementById('passwordInput').value.trim();
            if (PASSWORD_ACCOUNTS[pw]) {
                const acc = PASSWORD_ACCOUNTS[pw];
                currentUser = { uid: acc.odUid, displayName: acc.displayName, email: acc.email, isPasswordUser: true };
                showApp();
            } else alert('Kata laluan salah!');
        }
        function signOut() {
            if (currentUser && currentUser.isPasswordUser) { currentUser = null; hideApp(); }
            else auth.signOut();
        }

        async function initializeApp() {
            await loadUserData();
            await loadQuestTemplates();
            await loadPersistentQuests();
            await generateTodayQuests();
            updateHeaderDate();
            renderDaysSelector();
            switchScreen('today');
        }

        async function loadUserData() {
            const snap = await db.ref(`users/${currentUser.uid}`).once('value');
            const data = snap.val();
            if (data) {
                userExp = data.totalExp || 0;
                verifierCode = data.verifierCode || null;
                verifierUid = data.verifierUid || null;
            } else {
                const idCode = generateIdCode(currentUser.uid);
                await db.ref(`users/${currentUser.uid}`).set({
                    email: currentUser.email || currentUser.displayName,
                    displayName: currentUser.displayName || 'User',
                    totalExp: 0, idCode, createdAt: Date.now()
                });
            }
            updateLevelDisplay();
            await loadUsersToVerify();
        }

        async function loadUsersToVerify() {
            usersToVerify = []; pendingVerifyCount = 0;
            const snap = await db.ref('users').orderByChild('verifierUid').equalTo(currentUser.uid).once('value');
            snap.forEach(c => usersToVerify.push({ odUid: c.key, ...c.val() }));
            const today = getDateString(new Date());
            for (const user of usersToVerify) {
                const qSnap = await db.ref(`dailyQuests/${user.odUid}/${today}`).once('value');
                qSnap.forEach(c => { if (c.val().status === 'pending_verification') pendingVerifyCount++; });
                const pSnap = await db.ref(`persistentQuests/${user.odUid}`).once('value');
                pSnap.forEach(c => { if (c.val().status === 'pending_verification') pendingVerifyCount++; });
            }
        }

        async function loadQuestTemplates() {
            const snap = await db.ref(`questTemplates/${currentUser.uid}`).once('value');
            questTemplates = [];
            snap.forEach(c => questTemplates.push({ id: c.key, ...c.val() }));
        }

        async function loadPersistentQuests() {
            const snap = await db.ref(`persistentQuests/${currentUser.uid}`).once('value');
            persistentQuests = [];
            snap.forEach(c => { if (c.val().status !== 'completed') persistentQuests.push({ id: c.key, ...c.val() }); });
        }

        async function generateTodayQuests() {
            const today = getDateString(new Date());
            const dow = new Date().getDay();
            const adjDay = dow === 0 ? 7 : dow;
            const snap = await db.ref(`dailyQuests/${currentUser.uid}/${today}`).once('value');
            const existing = snap.val() || {};
            const existingIds = Object.values(existing).map(q => q.templateId);
            for (const t of questTemplates) {
                if (t.daysOfWeek && t.daysOfWeek.includes(adjDay) && !existingIds.includes(t.id)) {
                    await db.ref(`dailyQuests/${currentUser.uid}/${today}/${t.id}`).set({
                        templateId: t.id, title: t.title, category: t.category, status: 'pending', createdAt: Date.now()
                    });
                }
            }
            await loadTodayQuests();
        }

        async function loadTodayQuests() {
            const snap = await db.ref(`dailyQuests/${currentUser.uid}/${getDateString(new Date())}`).once('value');
            todayQuests = [];
            snap.forEach(c => todayQuests.push({ id: c.key, ...c.val() }));
        }

        function getDateString(d) { return d.toISOString().split('T')[0]; }
        function updateHeaderDate() {
            const now = new Date();
            const dayName = daysFull[now.getDay() === 0 ? 6 : now.getDay() - 1];
            document.getElementById('headerDate').textContent = `${dayName}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }
        function renderDaysSelector() {
            const cont = document.getElementById('daysSelector');
            cont.innerHTML = '';
            for (let i = 1; i <= 7; i++) cont.innerHTML += `<input type="checkbox" class="day-checkbox" id="day${i}" value="${i}"><label class="day-label" for="day${i}">${days[i-1]}</label>`;
        }
        function setQuestType(type) {
            questType = type;
            document.getElementById('dailyTypeBtn').classList.toggle('active', type === 'daily');
            document.getElementById('persistentTypeBtn').classList.toggle('active', type === 'persistent');
            document.getElementById('daysGroup').classList.toggle('hidden', type === 'persistent');
        }
        function getCategoryIcon(cat) { return { home:'üè†', work:'üíº', health:'üí™', finance:'üí∞', learning:'üìö', personal:'üéØ' }[cat] || 'üìã'; }

        async function toggleQuestComplete(questId, isPersistent = false) {
            if (isPersistent) {
                const ref = db.ref(`persistentQuests/${currentUser.uid}/${questId}`);
                const snap = await ref.once('value');
                const quest = snap.val();
                if (quest && quest.status !== 'completed' && quest.status !== 'verified') {
                    const newStatus = verifierUid ? 'pending_verification' : 'completed';
                    await ref.update({ status: newStatus, completedAt: Date.now() });
                    if (newStatus === 'completed') await addExp(50);
                    playTickSound();
                    await loadPersistentQuests();
                    renderScreen();
                }
            } else {
                const dateStr = getDateString(new Date());
                const ref = db.ref(`dailyQuests/${currentUser.uid}/${dateStr}/${questId}`);
                const snap = await ref.once('value');
                const quest = snap.val();
                if (quest) {
                    if (quest.status === 'verified') return;
                    let newStatus;
                    if (quest.status === 'completed' || quest.status === 'pending_verification') newStatus = 'pending';
                    else { newStatus = verifierUid ? 'pending_verification' : 'completed'; playTickSound(); }
                    await ref.update({ status: newStatus, completedAt: newStatus !== 'pending' ? Date.now() : null });
                    await loadTodayQuests();
                    if (newStatus === 'completed') await checkAndAwardExp(dateStr);
                    renderScreen();
                }
            }
        }

        async function addExp(amount) {
            const oldLevel = calculateLevel(userExp).level;
            userExp += amount;
            await db.ref(`users/${currentUser.uid}/totalExp`).set(userExp);
            if (calculateLevel(userExp).level > oldLevel) { playLevelUpSound(); celebrate(); }
            updateLevelDisplay();
        }

        async function checkAndAwardExp(dateStr) {
            const allDone = todayQuests.every(q => q.status === 'completed' || q.status === 'verified');
            const canAward = verifierUid ? todayQuests.every(q => q.status === 'verified') : allDone;
            if (canAward && todayQuests.length > 0) {
                const rewardKey = `reward_${dateStr}`;
                const snap = await db.ref(`rewards/${currentUser.uid}/${rewardKey}`).once('value');
                if (!snap.exists()) {
                    const expGain = todayQuests.length * 10 + 20;
                    await addExp(expGain);
                    await db.ref(`rewards/${currentUser.uid}/${rewardKey}`).set({ date: dateStr, exp: expGain, createdAt: Date.now() });
                    celebrate();
                }
            }
        }

        function openVerifierModal() { document.getElementById('verifierModal').classList.add('active'); }
        function closeVerifierModal() { document.getElementById('verifierModal').classList.remove('active'); document.getElementById('verifierCodeInput').value = ''; }
        async function addVerifierByCode() {
            const code = document.getElementById('verifierCodeInput').value.trim().toUpperCase();
            if (!code) return;
            const snap = await db.ref('users').orderByChild('idCode').equalTo(code).once('value');
            if (!snap.exists()) { alert('ID Code tidak dijumpai!'); return; }
            let foundUid = null;
            snap.forEach(c => foundUid = c.key);
            if (foundUid === currentUser.uid) { alert('Anda tidak boleh jadi pengesah sendiri!'); return; }
            verifierUid = foundUid; verifierCode = code;
            await db.ref(`users/${currentUser.uid}`).update({ verifierCode: code, verifierUid: foundUid });
            closeVerifierModal();
            renderScreen();
        }
        async function removeVerifier() {
            verifierCode = null; verifierUid = null;
            await db.ref(`users/${currentUser.uid}`).update({ verifierCode: null, verifierUid: null });
            renderScreen();
        }

        async function verifyQuest(userUid, dateStr, questId, isPersistent = false) {
            const path = isPersistent ? `persistentQuests/${userUid}/${questId}` : `dailyQuests/${userUid}/${dateStr}/${questId}`;
            await db.ref(path).update({ status: 'verified', verifiedAt: Date.now(), verifiedBy: currentUser.uid });
            if (isPersistent) {
                const uSnap = await db.ref(`users/${userUid}`).once('value');
                const uData = uSnap.val();
                await db.ref(`users/${userUid}/totalExp`).set((uData.totalExp || 0) + 50);
            }
            playTickSound();
            await loadUsersToVerify();
            renderScreen();
        }
        async function rejectQuest(userUid, dateStr, questId, isPersistent = false) {
            const path = isPersistent ? `persistentQuests/${userUid}/${questId}` : `dailyQuests/${userUid}/${dateStr}/${questId}`;
            await db.ref(path).update({ status: 'pending', completedAt: null });
            await loadUsersToVerify();
            renderScreen();
        }
        async function verifyAllQuests(userUid, dateStr) {
            const snap = await db.ref(`dailyQuests/${userUid}/${dateStr}`).once('value');
            const updates = {};
            snap.forEach(c => {
                if (c.val().status === 'pending_verification') {
                    updates[`${c.key}/status`] = 'verified';
                    updates[`${c.key}/verifiedAt`] = Date.now();
                    updates[`${c.key}/verifiedBy`] = currentUser.uid;
                }
            });
            if (Object.keys(updates).length > 0) {
                await db.ref(`dailyQuests/${userUid}/${dateStr}`).update(updates);
                const rewardKey = `reward_${dateStr}`;
                const rSnap = await db.ref(`rewards/${userUid}/${rewardKey}`).once('value');
                if (!rSnap.exists()) {
                    const uSnap = await db.ref(`users/${userUid}`).once('value');
                    const uData = uSnap.val();
                    const expGain = Object.keys(updates).length / 3 * 10 + 20;
                    await db.ref(`users/${userUid}/totalExp`).set((uData.totalExp || 0) + expGain);
                    await db.ref(`rewards/${userUid}/${rewardKey}`).set({ date: dateStr, exp: expGain, createdAt: Date.now(), verifiedBy: currentUser.uid });
                }
            }
            playTickSound();
            await loadUsersToVerify();
            renderScreen();
        }
        function toggleVerifierMode() { isVerifierMode = !isVerifierMode; renderScreen(); }

        function openAddQuestModal() {
            document.getElementById('questModalTitle').textContent = 'Tambah Quest';
            document.getElementById('questId').value = '';
            document.getElementById('questTitle').value = '';
            document.getElementById('questCategory').value = 'home';
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            setQuestType('daily');
            document.getElementById('questModal').classList.add('active');
        }
        function closeQuestModal() { document.getElementById('questModal').classList.remove('active'); }
        async function saveQuest(e) {
            e.preventDefault();
            const title = document.getElementById('questTitle').value.trim();
            const category = document.getElementById('questCategory').value;
            if (questType === 'persistent') {
                await db.ref(`persistentQuests/${currentUser.uid}`).push({ title, category, isPersistent: true, status: 'pending', createdAt: Date.now() });
                await loadPersistentQuests();
            } else {
                const selectedDays = [];
                document.querySelectorAll('.day-checkbox:checked').forEach(cb => selectedDays.push(parseInt(cb.value)));
                if (selectedDays.length === 0) { alert('Sila pilih sekurang-kurangnya satu hari'); return; }
                const questId = document.getElementById('questId').value;
                const data = { title, category, daysOfWeek: selectedDays, updatedAt: Date.now() };
                if (questId) await db.ref(`questTemplates/${currentUser.uid}/${questId}`).update(data);
                else { data.createdAt = Date.now(); await db.ref(`questTemplates/${currentUser.uid}`).push(data); }
                await loadQuestTemplates();
                await generateTodayQuests();
            }
            closeQuestModal();
            renderScreen();
        }
        function openEditQuestModal(questId) {
            const quest = questTemplates.find(q => q.id === questId);
            if (!quest) return;
            document.getElementById('questModalTitle').textContent = 'Edit Quest';
            document.getElementById('questId').value = questId;
            document.getElementById('questTitle').value = quest.title;
            document.getElementById('questCategory').value = quest.category;
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = quest.daysOfWeek && quest.daysOfWeek.includes(parseInt(cb.value)));
            setQuestType('daily');
            document.getElementById('questModal').classList.add('active');
        }
        function openDeleteModal(questId) { deleteTarget = questId; document.getElementById('deleteModal').classList.add('active'); }
        function closeDeleteModal() { deleteTarget = null; document.getElementById('deleteModal').classList.remove('active'); }
        async function confirmDelete() {
            if (deleteTarget) {
                await db.ref(`questTemplates/${currentUser.uid}/${deleteTarget}`).remove();
                await loadQuestTemplates();
                closeDeleteModal();
                renderScreen();
            }
        }
        async function deletePersistentQuest(questId) {
            if (confirm('Padam quest berterusan ini?')) {
                await db.ref(`persistentQuests/${currentUser.uid}/${questId}`).remove();
                await loadPersistentQuests();
                renderScreen();
            }
        }

        function celebrate() {
            const cont = document.getElementById('celebration');
            const colors = ['#00b894', '#55efc4', '#ffd700', '#fd79a8', '#a29bfe'];
            for (let i = 0; i < 50; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + '%';
                conf.style.top = '-10px';
                conf.style.background = colors[Math.floor(Math.random() * colors.length)];
                conf.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                conf.style.animationDelay = Math.random() * 0.5 + 's';
                cont.appendChild(conf);
                setTimeout(() => conf.remove(), 3000);
            }
        }

        function getWeekSummary() {
            const summary = [];
            const dow = new Date().getDay();
            const adjToday = dow === 0 ? 7 : dow;
            for (let i = 1; i <= 7; i++) {
                if (i < adjToday) summary.push({ status: 'completed', icon: '‚úì' });
                else if (i === adjToday) summary.push({ status: 'today', icon: 'üìç' });
                else summary.push({ status: 'future', icon: '¬∑' });
            }
            return summary;
        }

        function switchScreen(screen) {
            currentScreen = screen;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screen));
            document.getElementById('fabBtn').classList.toggle('hidden', screen === 'history' || screen === 'settings');
            renderScreen();
        }

        async function renderScreen() {
            const content = document.getElementById('mainContent');
            switch(currentScreen) {
                case 'today': await renderTodayScreen(content); break;
                case 'quests': renderQuestsScreen(content); break;
                case 'history': await renderHistoryScreen(content); break;
                case 'settings': await renderSettingsScreen(content); break;
            }
        }

        async function renderTodayScreen(container) {
            let html = '';
            if (usersToVerify.length > 0) {
                html += `<div class="mode-toggle">
                    <button class="mode-btn ${!isVerifierMode ? 'active' : ''}" onclick="toggleVerifierMode()">‚öîÔ∏è Quest Saya</button>
                    <button class="mode-btn ${isVerifierMode ? 'active' : ''}" onclick="toggleVerifierMode()">‚úÖ Mode Pengesah ${pendingVerifyCount > 0 ? `<span class="badge">${pendingVerifyCount}</span>` : ''}</button>
                </div>`;
            }
            html += isVerifierMode ? await renderVerifierContent() : await renderUserQuestsContent();
            container.innerHTML = html;
        }

        async function renderUserQuestsContent() {
            const completed = todayQuests.filter(q => ['completed','pending_verification','verified'].includes(q.status)).length;
            const total = todayQuests.length;
            const pct = total > 0 ? (completed / total * 100) : 0;
            const week = getWeekSummary();
            let html = `<div class="progress-section">
                <div class="progress-header"><span class="progress-title">Quest Hari Ini</span><span class="progress-count">${completed}/${total}</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width: ${pct}%"></div></div>
                <div class="week-summary">${week.map((d,i) => `<div class="week-day ${d.status}"><span>${days[i]}</span><span>${d.icon}</span></div>`).join('')}</div>
            </div>`;
            if (verifierUid) {
                const pending = todayQuests.filter(q => q.status === 'pending_verification').length;
                if (pending > 0) html += `<div class="verifier-status"><div class="verifier-status-info"><span>‚è≥</span><span>${pending} quest menunggu pengesahan</span></div></div>`;
            }
            if (persistentQuests.length > 0) {
                html += `<div class="quest-section"><div class="section-header"><h3 class="section-title">üìå Berterusan</h3></div><div class="quest-list">`;
                persistentQuests.forEach(q => {
                    const statusClass = q.status === 'pending_verification' ? 'pending_verification' : q.status;
                    html += `<div class="quest-item persistent ${statusClass}" onclick="toggleQuestComplete('${q.id}', true)">
                        <div class="quest-checkbox"></div>
                        <div class="quest-content">
                            <div class="quest-title">${q.title}</div>
                            <div class="quest-meta">
                                <span class="quest-category category-${q.category}">${getCategoryIcon(q.category)}</span>
                                <span class="persistent-badge">üìå Berterusan</span>
                                <span class="exp-reward">+50 EXP</span>
                            </div>
                        </div>
                        <button class="quest-action-btn" onclick="event.stopPropagation();deletePersistentQuest('${q.id}')">üóëÔ∏è</button>
                    </div>`;
                });
                html += '</div></div>';
            }
            if (todayQuests.length === 0 && persistentQuests.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Tiada quest untuk hari ini</div><p>Tambah quest pertama anda!</p></div>`;
            } else if (todayQuests.length > 0) {
                html += '<div class="quest-section"><div class="quest-list">';
                todayQuests.forEach(q => {
                    const statusClass = q.status === 'pending_verification' ? 'pending_verification' : q.status;
                    const badge = q.status === 'pending_verification' ? '<span class="pending-badge">‚è≥ Menunggu</span>' : q.status === 'verified' ? '<span class="verified-badge">‚úì‚úì Disahkan</span>' : '';
                    html += `<div class="quest-item ${statusClass}" onclick="toggleQuestComplete('${q.id}')">
                        <div class="quest-checkbox"></div>
                        <div class="quest-content">
                            <div class="quest-title">${q.title}</div>
                            <div class="quest-meta"><span class="quest-category category-${q.category}">${getCategoryIcon(q.category)}</span><span class="exp-reward">+10 EXP</span>${badge}</div>
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            }
            return html;
        }

        async function renderVerifierContent() {
            await loadUsersToVerify();
            if (usersToVerify.length === 0) return `<div class="empty-state"><div class="empty-icon">üëÅÔ∏è</div><div class="empty-title">Tiada pengguna untuk disahkan</div></div>`;
            const today = getDateString(new Date());
            let html = '';
            for (const user of usersToVerify) {
                const qSnap = await db.ref(`dailyQuests/${user.odUid}/${today}`).once('value');
                const quests = []; qSnap.forEach(c => quests.push({ id: c.key, ...c.val() }));
                const pSnap = await db.ref(`persistentQuests/${user.odUid}`).once('value');
                const pQuests = []; pSnap.forEach(c => { if (c.val().status === 'pending_verification') pQuests.push({ id: c.key, ...c.val() }); });
                const pending = quests.filter(q => q.status === 'pending_verification');
                html += `<div class="verify-user-card"><div class="verify-user-header"><div class="verify-user-info"><span style="font-size:24px">üë§</span><div><div class="verify-user-name">${user.displayName || user.email}</div><div class="verify-user-count">${pending.length + pQuests.length} quest untuk disahkan</div></div></div>
                    ${pending.length > 0 ? `<button class="btn btn-primary btn-sm" onclick="verifyAllQuests('${user.odUid}','${today}')">Sahkan Semua</button>` : ''}</div>`;
                if (pQuests.length > 0) {
                    html += '<div style="margin-bottom:8px;font-size:12px;color:var(--persistent);font-weight:600">üìå Berterusan</div>';
                    pQuests.forEach(q => {
                        html += `<div class="verify-quest-item"><div class="verify-quest-info"><span>${getCategoryIcon(q.category)}</span><span>${q.title}</span></div>
                            <div class="verify-quest-actions"><button class="btn-icon btn-verify" onclick="verifyQuest('${user.odUid}','${today}','${q.id}',true)">‚úì</button><button class="btn-icon btn-reject" onclick="rejectQuest('${user.odUid}','${today}','${q.id}',true)">‚úó</button></div></div>`;
                    });
                }
                if (pending.length > 0) {
                    html += '<div style="margin-bottom:8px;font-size:12px;color:var(--text-muted);font-weight:600">üìÖ Harian</div>';
                    pending.forEach(q => {
                        html += `<div class="verify-quest-item"><div class="verify-quest-info"><span>${getCategoryIcon(q.category)}</span><span>${q.title}</span></div>
                            <div class="verify-quest-actions"><button class="btn-icon btn-verify" onclick="verifyQuest('${user.odUid}','${today}','${q.id}')">‚úì</button><button class="btn-icon btn-reject" onclick="rejectQuest('${user.odUid}','${today}','${q.id}')">‚úó</button></div></div>`;
                    });
                } else if (pQuests.length === 0) html += `<p style="color:var(--text-muted);font-size:13px;padding:8px 0">‚úÖ Semua quest telah disahkan</p>`;
                html += '</div>';
            }
            return html;
        }

        function renderQuestsScreen(container) {
            let html = `<div class="section-header"><h3 class="section-title">Template Quest</h3></div>`;
            if (questTemplates.length === 0) html += `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Tiada template quest</div><p>Tambah quest pertama anda!</p></div>`;
            else {
                questTemplates.forEach(t => {
                    html += `<div class="template-item"><div class="template-header"><div><div class="template-title">${t.title}</div><span class="quest-category category-${t.category}">${getCategoryIcon(t.category)} ${t.category}</span></div>
                        <div class="quest-actions"><button class="quest-action-btn" onclick="openEditQuestModal('${t.id}')">‚úèÔ∏è</button><button class="quest-action-btn" onclick="openDeleteModal('${t.id}')">üóëÔ∏è</button></div></div>
                        <div class="template-days">${t.daysOfWeek.map(d => `<span class="template-day">${days[d-1]}</span>`).join('')}</div></div>`;
                });
            }
            container.innerHTML = html;
        }

        async function renderHistoryScreen(container) {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            let html = `<div class="section-header"><h3 class="section-title">${months[today.getMonth()]} ${today.getFullYear()}</h3></div>`;
            let hasHistory = false;
            for (let d = new Date(today); d >= firstDay; d.setDate(d.getDate() - 1)) {
                const date = new Date(d);
                const dateStr = getDateString(date);
                const isToday = dateStr === getDateString(today);
                const snap = await db.ref(`dailyQuests/${currentUser.uid}/${dateStr}`).once('value');
                const dayName = daysFull[date.getDay() === 0 ? 6 : date.getDay() - 1];
                const dateDisplay = `${date.getDate()} ${months[date.getMonth()]}`;
                if (snap.exists()) {
                    hasHistory = true;
                    const quests = []; snap.forEach(c => quests.push(c.val()));
                    const completed = quests.filter(q => ['completed','pending_verification','verified'].includes(q.status)).length;
                    const total = quests.length;
                    const allDone = completed === total && total > 0;
                    const hasFailed = quests.some(q => q.status === 'failed');
                    let icon, cls;
                    if (allDone) { icon = '‚úÖ'; cls = 'success'; }
                    else if (hasFailed) { icon = '‚ùå'; cls = 'failed'; }
                    else { icon = isToday ? 'üìç' : '‚è≥'; cls = 'pending'; }
                    html += `<div class="history-item" onclick="toggleHistoryItem('hist-${dateStr}')">
                        <div class="history-header"><div class="history-left"><span class="history-status-icon">${icon}</span><div class="history-info"><span class="history-date-text">${dayName}, ${dateDisplay}${isToday ? ' (Hari Ini)' : ''}</span><span class="history-summary ${cls}">${completed}/${total} selesai</span></div></div>
                        <div class="history-right">${allDone ? '<span class="history-exp">+' + (total * 10 + 20) + ' EXP</span>' : ''}<span class="history-arrow" id="arrow-hist-${dateStr}">‚ñº</span></div></div>
                        <div class="history-details hidden" id="hist-${dateStr}">${quests.map(q => `<div class="history-quest-item ${['completed','pending_verification','verified'].includes(q.status) ? 'done' : 'undone'}"><span class="history-quest-check">${['completed','pending_verification','verified'].includes(q.status) ? '‚úì' : '‚óã'}</span><span>${getCategoryIcon(q.category)}</span><span>${q.title}</span></div>`).join('')}</div></div>`;
                } else if (!isToday) {
                    html += `<div class="history-item" style="opacity:0.5"><div class="history-header"><div class="history-left"><span class="history-status-icon">‚ûñ</span><div class="history-info"><span class="history-date-text">${dayName}, ${dateDisplay}</span><span class="history-summary" style="color:var(--text-muted);font-style:italic">Tiada quest</span></div></div></div></div>`;
                }
            }
            if (!hasHistory) html += `<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Tiada sejarah</div></div>`;
            container.innerHTML = html;
        }
        function toggleHistoryItem(itemId) {
            const details = document.getElementById(itemId);
            const arrow = document.getElementById('arrow-' + itemId);
            if (details.classList.contains('hidden')) { details.classList.remove('hidden'); arrow.textContent = '‚ñ≤'; }
            else { details.classList.add('hidden'); arrow.textContent = '‚ñº'; }
        }

        async function renderSettingsScreen(container) {
            const snap = await db.ref(`users/${currentUser.uid}`).once('value');
            const userData = snap.val() || {};
            const idCode = userData.idCode || generateIdCode(currentUser.uid);
            const levelData = calculateLevel(userExp);
            let html = `<div class="settings-section"><div class="settings-title">Akaun</div>
                <div class="user-info"><div class="user-avatar">${currentUser.photoURL ? `<img src="${currentUser.photoURL}">` : 'üë§'}</div><div><div class="user-name">${currentUser.displayName || 'User'}</div><div class="user-email">${currentUser.email}</div></div></div></div>
                <div class="settings-section"><div class="settings-title">üìä Level & EXP</div>
                    <div class="settings-item"><span class="settings-item-label">Level</span><span style="font-weight:700;color:var(--primary)">${userLevel}</span></div>
                    <div class="settings-item"><span class="settings-item-label">Total EXP</span><span>${userExp} EXP</span></div>
                    <div class="settings-item"><span class="settings-item-label">Next Level</span><span>${levelData.expNeeded - levelData.currentExp} EXP lagi</span></div></div>
                <div class="settings-section"><div class="settings-title">üÜî ID Code Anda</div>
                    <div class="id-code-display"><div class="id-code-label">Kongsi kod ini untuk orang lain tambah anda sebagai pengesah</div><div class="id-code">${idCode}</div>
                    <button class="copy-btn" onclick="navigator.clipboard.writeText('${idCode}');this.textContent='Disalin!'">Salin</button></div></div>
                <div class="settings-section"><div class="settings-title">üëÅÔ∏è Pengesah</div>
                    ${verifierCode ? `<div class="settings-item"><span class="settings-item-label">Pengesah: ${verifierCode}</span><button class="btn btn-danger btn-sm" onclick="removeVerifier()">Buang</button></div>` : `<div class="settings-item"><span class="settings-item-label">Tiada pengesah</span><button class="btn btn-primary btn-sm" onclick="openVerifierModal()">Tambah</button></div>`}</div>
                <button class="btn btn-danger" onclick="signOut()" style="margin-top:24px">Log Keluar</button>`;
            container.innerHTML = html;
        }
    </script>
</body>
</html>
